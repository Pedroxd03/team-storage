import os
import matplotlib.pyplot as plt
import pandas as pd

def main():
    # Get the current script's directory path
    script_path = os.path.dirname(os.path.abspath(__file__))

    # Get the list of CSV files in the directory
    csv_files = [f for f in os.listdir(script_path) if f.endswith("battery_data_sustrend_bank_2023-11-14_11-32-36.csv")]

    # Check if there are any CSV files
    if not csv_files:
        print("No CSV files found in the directory.")
        return

    # Select the latest CSV file based on modification time
    latest_csv = max(csv_files, key=lambda x: os.path.getmtime(os.path.join(script_path, x)))

    # Specify the CSV file to be read
    absolute_csv_path = os.path.join(script_path, latest_csv)

    # Read the CSV file
    data_frame = pd.read_csv(absolute_csv_path)

    # Get the number of cells dynamically
    N_CELLS = sum("Voltage" in col for col in data_frame.columns)

    # Initialize the figure for plotting
    plt.figure(figsize=(10, 6))

    # Calculate time intervals in seconds
    time_intervals = range(len(data_frame))

    # Convert time intervals to hours by dividing by 3600
    hours = [t / 3600 for t in time_intervals]

    # Plot voltage for each cell
    for cell_number in range(1, N_CELLS + 1):
        voltage_column = f"Cell {cell_number} Voltage"
        plt.plot(hours, data_frame[voltage_column], label=f"{voltage_column} (V)")

    # Sum of voltage for all cells
    total_voltage = data_frame[[f"Cell {i} Voltage" for i in range(1, N_CELLS + 1)]].sum(axis=1)
    plt.plot(hours, total_voltage, label="Total Voltage (V)", linewidth=2)  # Eliminado el argumento linestyle='--'

    # Set labels and title
    plt.xlabel('Time (hours)')
    plt.ylabel('Voltage (V)')
    plt.title('Voltage vs Time for Each Cell and Total Voltage')
    plt.legend()
    plt.grid(True)
    plt.tight_layout()

    # Save the plot as an image
    plt.savefig(absolute_csv_path + "_voltage_plot.png")

    # Show the plot
    plt.show()

if __name__ == "__main__":
    main()