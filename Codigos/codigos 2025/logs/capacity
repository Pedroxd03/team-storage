import os
import pandas as pd

def calculate_real_capacity(data_frame, nominal_capacity_mah):
    # Filtrar solo los intervalos de descarga (corriente negativa)
    discharge_data = data_frame[data_frame['Current'] < 0]

    # Calcular la capacidad real en cada intervalo de descarga
    real_capacity_ah = -(discharge_data['Current'] * discharge_data['Timestamp'].diff().dt.total_seconds()).cumsum() / (60 * 60)  # Convertir a Ah

    # Calcular la capacidad real en mAh
    real_capacity_mah = real_capacity_ah * 1000

    return real_capacity_mah

def main():
    # Obtener la ruta del directorio del script
    script_path = os.path.dirname(os.path.abspath(__file__))

    # Especificar el archivo CSV a leer
    csv_file = "battery_HPPC_2024-08-26_10-47-20.csv"
    absolute_csv_path = os.path.join(script_path, csv_file)

    # Leer el archivo CSV
    data_frame = pd.read_csv(absolute_csv_path, parse_dates=['Timestamp'])

    # Capacidad nominal de la celda en mAh
    nominal_capacity_mah = 2600

    # Calcular la capacidad real durante los intervalos de descarga para la celda 1
    real_capacity_cell1 = calculate_real_capacity(data_frame, nominal_capacity_mah)

    # Mostrar la capacidad real en mAh para la celda 1
    print("Capacidad real de la celda 1 durante los intervalos de descarga:")
    print(real_capacity_cell1)

if __name__ == "__main__":
    main()